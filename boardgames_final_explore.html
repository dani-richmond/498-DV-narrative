<!DOCTYPE html>
<meta charset="utf-8">
<html>
<!-- Load d3.js -->
<script src="https://d3js.org/d3.v5.min.js"></script>
<!-- Color Scale -->
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<style>
    #tooltip {
        opacity: 0;
        position: absolute;
        text-align: center;
        width: auto;
        height: auto;
        background: rgb(238, 229, 234);
        border: 1px solid black;
        padding: 8px 16px;
    }

    #my_dataviz {
        width: 80%;
        height: auto;
    }

    #svg {
        width: 75%;
        height: auto;
    }

    .button {
        border: 2px solid black;
        background-color: white;
        color: black;
        padding: 16px 32px;
        text-align: center;
        font-size: 16px;
        display: inline-block;
        margin: 4px 2px;
        transition-duration: 0.4s;
        cursor: pointer;
    }

    .button:hover {
        background-color: rgb(238, 229, 234);
    }
</style>
<title>Board Game Data</title>
<h2 style="text-align:center"><b>Exploration of Board Game Data per Year</b></h2>
<!-- Create a div where the graph will take place -->
<div id="my_dataviz" style="float:left"></div>
<!--Create div for explanation of graph-->
<div style="float:right, width 20%; word-break: break-word; word-wrap: break-word;">
    <p>
        yada yada board game data yada yada
        explain what the filters mean
    </p>
    <button class="button" onclick="window.location.href='boardgames_year_mechanics.html';"
        style="float:left">Back</button>
    <button class="button" onclick="window.location.href='index.html';" style="float:right">Restart</button>

</div>
<!-- Initialize a select button -->
<select id="selectButton"></select>
<!--create div for tooltip-->
<div id="tooltip"></div>

<body onload='init()'>
    <script>

        // set the dimensions and margins of the graph
        var margin = { top: 10, right: 30, bottom: 40, left: 60 },
            width = 900 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

        // append the svg object to the body of the page
        var svg = d3.select("#my_dataviz")
            .append("svg")
            //.attr("viewBox", '0 0 500 800')
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

        // initialize variables
        var data;
        var parseTime = d3.timeParse("%Y");
        var formatTime = d3.timeFormat("%Y");
        var formatNumber = d3.format(".3r")

        //Read the data
        async function init() {
            data = await d3.csv("https://raw.githubusercontent.com/dani-richmond/498-DV-narrative/master/boardgames_final_exploration.csv")
                .then(function (data) {


                    data.forEach(function (d) {
                        d.year = parseTime(d.year);
                        d.total = +d.Total;
                        d.ave_minage = +d['Average of Min Player Age'];
                        d.ave_minplayers = +d["Average of Min Players"];
                        d.ave_maxplayers = +d["Average of Max Players"];
                        d.ave_minplaytime = +d["Average of Min Playtime"];
                        d.ave_maxplaytime = +d["Average of Max Playtime"];
                        d.ave_userscore = +d["Average User Score"];
                        d.ave_complexity = +d["Average Complexity Rating"];
                        d.ave_num_designers = +d["Average Number of Designers"];
                        d.ave_num_artists = +d["Average Number of Artists"];
                        d.ave_num_publishers = +d["Average Number of Publishers"];
                        d.ave_num_honors = +d["Average Number of Honors"];
                        d.ave_num_category = +d["Average Count of Categories"];
                        d.ave_num_mechanic = +d["Average Count of Mechanics"];
                        d.ave_num_expansion = +d["Average Count of Expansions"];
                        d.ave_num_version = +d["Average Count of Versions"];
                    });

                    // List of groups (here I have one group per column)
                    var allGroup = ["Total", "Average of Min Player Age", "Average of Min Players", "Average of Max Players", "Average of Min Playtime", "Average of Max Playtime", "Average User Score", "Average Complexity Rating", "Average Number of Designers", 
                    "Average Number of Artists", "Average Number of Publishers", "Average Number of Honors", 
                    "Average Count of Categories", "Average Count of Mechanics", "Average Count of Expansions", "Average Count of Versions"]

                    // add the options to the button
                    d3.select("#selectButton")
                        .selectAll('myOptions')
                        .data(allGroup)
                        .enter()
                        .append('option')
                        .text(function (d) { return d; }) // text showed in the menu
                        .attr("value", function (d) { return d; }) // corresponding value returned by the button

                    // A color scale: one color for each group
                    var myColor = d3.scaleOrdinal()
                        .domain(allGroup)
                        .range(d3.schemeSet2);

                    // Add X axis
                    var x = d3.scaleTime()
                        .domain(d3.extent(data, function (d) { return d.year; }))
                        .range([0, width])

                    svg.append("g")
                        .attr("transform", "translate(0," + height + ")")
                        .call(d3.axisBottom(x));

                    // Add X axis label
                    svg.append("text")
                        .attr("transform",
                            "translate(" + (width / 2) + " ," +
                            (height + margin.top + 30) + ")")
                        .style("text-anchor", "middle")
                        .text("Year");

                    // Add Y axis
                    var y = d3.scaleLinear()
                        .domain([0, (d3.max(data, function (d) { return d.total; }) + 2)])
                        .range([height, 0]);
                    svg.append("g")
                        .attr("class", "yaxis")
                        .call(d3.axisLeft(y));

                    // Add Y axis label
                    svg.append("text")
                        .attr("class", "yaxis_label")
                        .attr("transform", "rotate(-90)")
                        .attr("y", 0 - margin.left)
                        .attr("x", 0 - (height / 2))
                        .attr("dy", "1em")
                        .style("text-anchor", "middle")
                        .text("Total")

                    // Add tooltip and tooltip actions
                    var tooltip = d3.select("#tooltip");

                    /*var mouseover = function (d) {
                        tooltip.style("opacity", 1)
                            .style("left", (d3.event.pageX + 15) + "px")
                            .style("top", (d3.event.pageY - 15) + "px")

                            .html(formatNumber(d.ave_minage) + " was the average minimum age <br> for games published in " + formatTime(d.year));
                        //console.log(JSON.stringify(d))
                    };*/
                    var mouseout = function () { tooltip.style("opacity", 0) };

                    // Add the line
                    var line = d3.line()
                        .x(function (d) { return x(d.year) })
                        .y(function (d) { return y(d.total) });

                    var path = svg.append("path")
                        .datum(data)
                        .attr("fill", "none")
                        .attr("stroke", function (d) { return myColor("Total") })
                        .attr("stroke-width", 1.5)
                        .attr("d", line);

                    // Add circles to line for tooltip to interact with
                    d3.select("svg").select("g").selectAll("circle")
                        .data(data).enter().append("circle")
                        .attr("r", 5)
                        .attr("cx", function (d) { return x(d.year); })
                        .attr("cy", function (d) { return y(d.total); })
                        .attr("fill", function (d) { return myColor("Total") })
                        .on("mouseover", function (d) {
                            tooltip.style("opacity", 1)
                                .style("left", (d3.event.pageX + 15) + "px")
                                .style("top", (d3.event.pageY - 15) + "px")
                                .html(formatNumber(d.total) + " in " + formatTime(d.year))
                        })
                        .on("mouseout", mouseout);

                    // A function that update the chart
                    function update(selectedGroup) {

                        // Create new data with the selection?
                        var dataFilter = data.map(function (d) { return { year: d.year, value: d[selectedGroup] } })

                        // Update Y Axis
                        y.domain([0, (d3.max(dataFilter, function (d) { return +d.value; }) + 2)])

                        svg.select(".yaxis")
                            .transition()
                            .duration(1000)
                            .call(d3.axisLeft(y));

                        svg.select(".yaxis_label")
                            .text(selectedGroup);

                        // Give these new data to update line
                        path
                            .datum(dataFilter)
                            .transition()
                            .duration(1000)
                            .attr("d", d3.line()
                                .x(function (d) { return x(+d.year) })
                                .y(function (d) { return y(+d.value) })
                            )
                            .attr("stroke", function (d) { return myColor(selectedGroup) })

                        /*var pathLength = path.node().getTotalLength();

                        var transitionPath = d3.transition()
                            .ease(d3.easeSin)
                            .duration(3000);

                        path.attr("stroke-dashoffset", pathLength)
                            .attr("stroke-dasharray", pathLength)
                            .transition(transitionPath)
                            .attr("stroke-dashoffset", 0);*/



                        //Update the circles
                        var dot = svg.selectAll("circle")
                            .data(dataFilter);

                        dot.exit().remove();

                        dot.enter().append("circle")
                            .attr("r", 5)
                            .merge(dot)
                            .transition()
                            .duration(1000)
                            .attr("cx", function (d) { return x(d.year); })
                            .attr("cy", function (d) { return y(+d.value); })
                            .attr("fill", function (d) { return myColor(selectedGroup) });
                        dot.on("mouseover", function (d) {
                            tooltip
                                .style("opacity", 1)
                                .style("left", (d3.event.pageX + 15) + "px")
                                .style("top", (d3.event.pageY - 15) + "px")
                                .html(d.value + " in " + formatTime(d.year))
                        })
                            .on("mouseout", mouseout)


                    }

                    // When the button is changed, run the updateChart function
                    d3.select("#selectButton").on("change", function (d) {
                        // recover the option that has been chosen
                        var selectedOption = d3.select(this).property("value")
                        // run the updateChart function with this selected option
                        update(selectedOption)
                    })
                })
                .catch(function (err) {
                    consol.log("error: " + err);
                })
        }
    </script>
</body>

</html>
